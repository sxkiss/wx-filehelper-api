<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{app_name}} - WebUI</title>
    <!-- ä½¿ç”¨ Inter å­—ä½“ï¼Œå¹¶å¾®è°ƒå­—é‡ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Apple å®˜æ–¹é…è‰²è§„èŒƒå¾®è°ƒ */
            --bg-color: #f5f5f7;
            --card-bg: rgba(255, 255, 255, 0.9);
            /* å¾®é€æ˜æ„Ÿ */
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            /* ç¨å¾®æ·±ä¸€ç‚¹çš„ç°è‰²ï¼Œå¢åŠ å¯è¯»æ€§ */
            --accent: #0071e3;
            --success: #34c759;
            --radius: 22px;

            /* æ›´å…·å±‚çº§æ„Ÿçš„é˜´å½± */
            --shadow-card: 0 10px 40px rgba(0, 0, 0, 0.04);
            --shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.08);

            /* ç»†è¾¹æ¡†ï¼ŒApple å¸¸è§çš„å¤„ç†æ–¹å¼ */
            --border-subtle: 1px solid rgba(0, 0, 0, 0.03);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.015em;
            /* Apple å–œæ¬¢çš„ç´§å‡‘å­—é—´è· */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px;
        }

        .container {
            width: 100%;
            max-width: 950px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        @media (max-width: 768px) {
            body {
                padding-top: 40px;
            }

            .top-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* æ ‡é¢˜éƒ¨åˆ† - æ›´åŠ å¤§æ°” */
        header {
            text-align: center;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(180deg, #1d1d1f 0%, #434344 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .version-badge {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.05);
            padding: 4px 14px;
            border-radius: 100px;
        }

        /* å¡ç‰‡å®¹å™¨ - å¢åŠ ç£¨ç ‚è´¨æ„Ÿ */
        .apple-card {
            background: #ffffff;
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow-card);
            border: var(--border-subtle);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.4s ease;
        }

        .apple-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .top-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 28px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 32px;
            letter-spacing: -0.02em;
        }

        /* ç™»å½•æ¨¡å—å¾®è°ƒ */
        .qr-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .qr-container {
            width: 200px;
            height: 200px;
            background: #fbfbfd;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 0, 0, 0.02);
            transition: all 0.3s;
        }

        .qr-container:hover {
            background: #fff;
            border-color: rgba(0, 0, 0, 0.1);
        }

        #qr-image {
            width: 170px;
            height: 170px;
            object-fit: contain;
            mix-blend-mode: multiply;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 24px;
            border-radius: 100px;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 32px;
            transition: all 0.3s;
        }

        .status-pill.waiting {
            background: #fef0e7;
            color: #ff9500;
        }

        .status-pill.logged-in {
            background: #eafaf1;
            color: #34c759;
        }

        .status-pill.error {
            background: #fff1f0;
            color: #ff3b30;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 10px currentColor;
            /* å¢åŠ å‘¼å¸æ„Ÿ */
        }

        /* æŒ‰é’®é‡å®šä¹‰ - æ›´åŠ ç²¾è‡´ */
        .apple-btn {
            font-family: inherit;
            font-weight: 500;
            font-size: 1rem;
            padding: 14px 28px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--text-primary);
            color: #fff;
        }

        .btn-primary:hover {
            opacity: 0.85;
            transform: scale(1.01);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #f5f5f7;
            color: var(--text-primary);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #eeeeef;
        }

        /* ç»Ÿè®¡åŒºå— - å¢åŠ è´¨æ„Ÿ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .stat-box {
            background: #fbfbfd;
            padding: 28px;
            border-radius: 24px;
            border: var(--border-subtle);
            transition: all 0.3s;
        }

        .stat-box:hover {
            background: #fff;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
        }

        .stat-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.03em;
        }

        /* æ¶ˆæ¯å‘é€åŒº - è¾“å…¥æ¡†ä¼˜åŒ– */
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            background: #fbfbfd;
            font-family: inherit;
            font-size: 1.15rem;
            color: var(--text-primary);
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        textarea:focus {
            background: #ffffff;
            border-color: var(--accent);
            box-shadow: 0 0 0 5px rgba(0, 113, 227, 0.08);
        }

        /* æ¶ˆæ¯å‘é€å·¥å…·æ å¸ƒå±€ */
        .message-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 20px;
        }

        .file-group {
            flex: 1;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        /* ç»Ÿä¸€å·¥å…·æ æŒ‰é’®å®½åº¦/é«˜åº¦ */
        .message-toolbar .apple-btn {
            width: auto;
            min-width: 120px;
            white-space: nowrap;
        }

        /* é™„ä»¶æ ‡ç­¾ */
        .file-tag {
            background: #f2f2f7;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
            margin-bottom: 8px;
            border: var(--border-subtle);
        }

        /* é¡µè„š - æ›´åŠ ä½è°ƒä¼˜é›… */
        footer {
            margin-top: 80px;
            padding: 40px 0;
            border-top: var(--border-subtle);
            width: 100%;
            max-width: 950px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 600px) {
            footer {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
        }

        footer .copyright {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        footer .links {
            display: flex;
            gap: 32px;
        }

        footer a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        footer a:hover {
            color: var(--accent);
        }

        /* Toast è½¬åœºæ•ˆæœ */
        .toast {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            padding: 14px 40px;
            border-radius: 100px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            font-size: 1rem;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .toast.show {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            visibility: visible;
        }

        /* çº¯é»‘åŠ è½½åŠ¨ç”» */
        .spinner {
            width: 26px;
            height: 26px;
            border: 3px solid rgba(0, 0, 0, 0.04);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <div class="container">
        <header>
            <h1>{{app_name}}</h1>
            <span class="version-badge">Version {{version}}</span>
        </header>

        <div class="top-grid">
            <!-- ç™»å½•ç®¡ç† -->
            <div class="apple-card">
                <h2 class="section-title">è¿æ¥è®¾å¤‡</h2>
                <div class="qr-section">
                    <div class="qr-container">
                        <div id="qr-placeholder" class="qr-placeholder">
                            <div class="spinner"></div>
                        </div>
                        <img id="qr-image" style="display:none;" alt="Login QR Code">
                    </div>

                    <div id="status-badge" class="status-pill waiting">
                        <span class="status-indicator"></span>
                        <span id="status-text">åˆå§‹åŒ–ä¸­</span>
                    </div>

                    <div id="refresh-info"
                        style="font-size:0.8rem; color:var(--text-secondary); margin-bottom: 32px; height: 1.2em; font-weight: 500;">
                    </div>

                    <div style="width: 100%;">
                        <button class="apple-btn btn-primary" onclick="refreshQR()">åˆ·æ–°äºŒç»´ç </button>
                        <button class="apple-btn btn-secondary" onclick="refreshStatus()">æ£€æŸ¥çŠ¶æ€</button>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="apple-card">
                <h2 class="section-title">è¿è¡ŒçŠ¶æ€</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-label">è¿è¡Œæ—¶é—´</span>
                        <span class="stat-value" id="stat-uptime">--</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">å®šæ—¶ä»»åŠ¡</span>
                        <span class="stat-value" id="stat-tasks">--</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">æ´»è·ƒæ’ä»¶</span>
                        <span class="stat-value" id="stat-plugins">--</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">èŠå¤©æ¨¡å¼</span>
                        <span class="stat-value" id="stat-chat">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯å‘é€ -->
        <div class="apple-card">
            <h2 class="section-title">å‘é€æ¶ˆæ¯</h2>
            <div style="position: relative; margin-bottom: 32px;">
                <textarea id="message-input" placeholder="è¾“å…¥ä½ æƒ³å‘é€çš„å†…å®¹..."></textarea>
                <div
                    style="position: absolute; bottom: 20px; right: 24px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">
                    Press Enter to Send</div>
            </div>

            <div class="message-toolbar">
                <div class="file-group">
                    <input type="file" id="file-input" multiple onchange="updateFileList()" style="display: none;">
                    <button class="apple-btn btn-secondary" onclick="document.getElementById('file-input').click()">ğŸ“
                        é€‰æ‹©æ–‡ä»¶</button>
                    <div id="file-list" class="file-list"></div>
                </div>

                <div class="button-group">
                    <button class="apple-btn btn-secondary" id="upload-btn" onclick="uploadFiles()"
                        disabled>å‘é€æ–‡ä»¶</button>
                    <button class="apple-btn btn-primary" id="send-btn" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="copyright">Designed for WeChat FileHelper Protocol</div>
        <div class="links">
            <a href="https://github.com/CJackHwang/wx-filehelper-api" target="_blank">GitHub</a>
            <a href="/docs" target="_blank">Documentation</a>
        </div>
    </footer>

    <script>
        // ä¿æŒæ ¸å¿ƒé€»è¾‘ä¸å˜
        let qrRefreshTimer = null;

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        async function fetchJSON(url) {
            const resp = await fetch(url);
            return resp.json();
        }

        function updateFileList() {
            const input = document.getElementById('file-input');
            const listDiv = document.getElementById('file-list');
            const uploadBtn = document.getElementById('upload-btn');
            listDiv.innerHTML = '';
            if (input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    const tag = document.createElement('div');
                    tag.className = 'file-tag';
                    tag.innerHTML = `<span>${input.files[i].name}</span><span style="cursor:pointer;opacity:0.5" onclick="removeFile(${i})">Ã—</span>`;
                    listDiv.appendChild(tag);
                }
                uploadBtn.disabled = false;
            } else { uploadBtn.disabled = true; }
        }

        function removeFile(index) {
            const input = document.getElementById('file-input');
            const dt = new DataTransfer();
            for (let i = 0; i < input.files.length; i++) { if (i !== index) dt.items.add(input.files[i]); }
            input.files = dt.files;
            updateFileList();
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) { showToast('è¾“å…¥å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
            const btn = document.getElementById('send-btn');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = 'Sending...';
            try {
                const resp = await fetch('/bot/sendMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                const data = await resp.json();
                if (data.ok) { showToast('æ¶ˆæ¯å·²å‘å‡º'); input.value = ''; }
                else showToast('å‘é€å¤±è´¥');
            } catch (e) { showToast('ç½‘ç»œè¿æ¥é”™è¯¯'); }
            finally { btn.disabled = false; btn.innerText = originalText; }
        }

        async function uploadFiles() {
            const input = document.getElementById('file-input');
            if (!input.files.length) return;
            const btn = document.getElementById('upload-btn');
            btn.disabled = true;
            for (let i = 0; i < input.files.length; i++) {
                btn.innerText = `Sending ${i + 1}...`;
                try {
                    const formData = new FormData();
                    formData.append('document', input.files[i]);
                    await fetch('/bot/sendDocument/upload', { method: 'POST', body: formData });
                } catch (e) { }
            }
            showToast('æ–‡ä»¶å·²å…¨éƒ¨å‘å‡º');
            input.value = ''; updateFileList();
            btn.disabled = false; btn.innerText = 'å‘é€æ–‡ä»¶';
        }

        async function refreshQR() {
            const placeholder = document.getElementById('qr-placeholder');
            const img = document.getElementById('qr-image');
            const badge = document.getElementById('status-badge');
            const info = document.getElementById('refresh-info');
            placeholder.style.display = 'flex';
            placeholder.innerHTML = '<div class="spinner"></div>';
            img.style.display = 'none';
            try {
                const data = await fetchJSON('/webui/qr');
                if (data.logged_in) { setLoggedInState(); }
                else if (data.qr_base64) {
                    img.src = 'data:image/png;base64,' + data.qr_base64;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                    badge.className = 'status-pill waiting';
                    document.getElementById('status-text').textContent = 'å¾…æ‰«ç ';
                    const remaining = Math.max(0, 240 - (data.uuid_age || 0));
                    info.textContent = `äºŒç»´ç æœ‰æ•ˆæœŸ: ${remaining}s`;
                    startQRAutoRefresh();
                }
            } catch (e) { }
        }

        function setLoggedInState() {
            document.getElementById('qr-placeholder').innerHTML = '<span style="font-size:3.5rem; color:var(--success);">âœ“</span>';
            document.getElementById('qr-placeholder').style.display = 'flex';
            document.getElementById('qr-image').style.display = 'none';
            document.getElementById('status-badge').className = 'status-pill logged-in';
            document.getElementById('status-text').textContent = 'åœ¨çº¿';
            document.getElementById('refresh-info').textContent = '';
            stopQRAutoRefresh();
        }

        async function refreshStatus() {
            try {
                const data = await fetchJSON('/webui/status');
                document.getElementById('stat-uptime').textContent = data.uptime_str || '--';
                document.getElementById('stat-tasks').textContent = data.tasks_count ?? '--';
                document.getElementById('stat-plugins').textContent = data.plugins_count ?? '--';
                document.getElementById('stat-chat').textContent = data.chat_enabled ? 'å¼€å¯' : 'å…³é—­';
                if (data.logged_in) setLoggedInState();
            } catch (e) { }
        }

        function startQRAutoRefresh() {
            if (qrRefreshTimer) return;
            const poll = async () => {
                try {
                    const data = await fetchJSON('/webui/status');
                    if (data.logged_in) { setLoggedInState(); refreshStatus(); return; }
                    if (data.login_code === 201) document.getElementById('status-text').textContent = 'è¯·æ‰‹æœºç¡®è®¤';
                } catch (e) { }
                qrRefreshTimer = setTimeout(poll, 3000);
            };
            qrRefreshTimer = setTimeout(poll, 3000);
        }

        function stopQRAutoRefresh() { if (qrRefreshTimer) { clearTimeout(qrRefreshTimer); qrRefreshTimer = null; } }

        document.getElementById('message-input').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        refreshQR(); refreshStatus(); setInterval(refreshStatus, 15000);
    </script>
</body>

</html>